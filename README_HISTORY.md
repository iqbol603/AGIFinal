# üìö –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ –≤ Telegram –±–æ—Ç–µ

## üéØ –û–ø–∏—Å–∞–Ω–∏–µ

–¢–µ–ø–µ—Ä—å –≤–∞—à Telegram –±–æ—Ç —Å –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º –º–æ–∂–µ—Ç **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å** –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ–± –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ –∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–æ–≤ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `ai_messages`.

## ‚ú® –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### üîç –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤ –æ–± –∏—Å—Ç–æ—Ä–∏–∏
–ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç —Ñ—Ä–∞–∑—ã —Ç–∏–ø–∞:
- "—á—Ç–æ –º—ã –æ–±—Å—É–∂–¥–∞–ª–∏ —Ä–∞–Ω—å—à–µ?"
- "–ø–æ–∫–∞–∂–∏ –∏—Å—Ç–æ—Ä–∏—é –Ω–∞—à–∏—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤"
- "–Ω–∞–ø–æ–º–Ω–∏, –æ —á–µ–º –º—ã –≥–æ–≤–æ—Ä–∏–ª–∏"
- "—á—Ç–æ —è –ø–∏—Å–∞–ª —Ä–∞–Ω–µ–µ?"
- "–ø–æ–∫–∞–∂–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è"
- "–∏—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞"
- "–ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã"
- "—á—Ç–æ –º—ã –æ–±—Å—É–∂–¥–∞–ª–∏?"
- "–Ω–∞–ø–æ–º–Ω–∏ –º–Ω–µ"
- "–ø–æ–∫–∞–∂–∏ —á—Ç–æ —è –ø–∏—Å–∞–ª"
- "–∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π"

### üìä –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `history_get`
- **–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–Ω—è–º** (—Å–µ–≥–æ–¥–Ω—è, –≤—á–µ—Ä–∞, 2 –¥–Ω—è –Ω–∞–∑–∞–¥)
- **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏** –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —á—Ç–µ–Ω–∏—è
- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã** —Å–æ–æ–±—â–µ–Ω–∏–π (–¥–æ 3000 —Å–∏–º–≤–æ–ª–æ–≤)
- **–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ** —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã `ai_messages`
```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ MySQL –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
mysql -u your_user -p your_database < create_ai_messages_table.sql
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç:
node test_history.js
```

## üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã `ai_messages`

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `id` | bigint | –ê–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç |
| `chat_id` | varchar(255) | ID —á–∞—Ç–∞ Telegram |
| `role` | enum | –†–æ–ª—å: user/assistant/system/tool |
| `content` | longtext | –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏—è |
| `meta` | json | –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞, threadId, etc.) |
| `tokens_in` | int | –í—Ö–æ–¥—è—â–∏–µ —Ç–æ–∫–µ–Ω—ã |
| `tokens_out` | int | –ò—Å—Ö–æ–¥—è—â–∏–µ —Ç–æ–∫–µ–Ω—ã |
| `created_at` | timestamp | –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è |

## üîß –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```javascript
// –ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è
await this.safeLogMessage({ 
  chatId: userMeta.tg_chat_id, 
  role: 'user', 
  content: userText, 
  meta: userMeta 
});

// –ö–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è
await this.safeLogMessage({
  chatId: userMeta.tg_chat_id,
  role: 'assistant',
  content: text || '',
  meta: { threadId, runId }
});
```

### 2. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤ –æ–± –∏—Å—Ç–æ—Ä–∏–∏
```javascript
const historyKeywords = [
  '–∏—Å—Ç–æ—Ä–∏—è', '–æ–±—Å—É–∂–¥–∞–ª–∏', '–≥–æ–≤–æ—Ä–∏–ª–∏', '–ø–∏—Å–∞–ª',
  '–Ω–∞–ø–æ–º–Ω–∏', '–ø–æ–∫–∞–∂–∏', '—Ä–∞–Ω—å—à–µ', '—Ä–∞–Ω–µ–µ'
];

const isHistoryQuestion = historyKeywords.some(keyword => 
  userText.toLowerCase().includes(keyword.toLowerCase())
);
```

### 3. –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ `history_get`
```javascript
// –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç:
history_get(limit=20)

// –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é:
{
  ok: true,
  messages: [...],
  grouped_by_day: {
    "—Å–µ–≥–æ–¥–Ω—è": [...],
    "–≤—á–µ—Ä–∞": [...],
    "2 –¥–Ω—è –Ω–∞–∑–∞–¥": [...]
  },
  summary: "–ù–∞–π–¥–µ–Ω–æ X —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞"
}
```

## üì± –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç:
> "–ü–æ–∫–∞–∂–∏ –∏—Å—Ç–æ—Ä–∏—é –Ω–∞—à–∏—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤"

### –ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. üéØ –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≤–æ–ø—Ä–æ—Å –æ–± –∏—Å—Ç–æ—Ä–∏–∏
2. üîç –í—ã–∑—ã–≤–∞–µ—Ç `history_get(limit=20)`
3. üìä –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –¥–Ω—è–º
4. üìù –§–æ—Ä–º–∏—Ä—É–µ—Ç —á–∏—Ç–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç

### –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:
```
üìö –ò—Å—Ç–æ—Ä–∏—è –Ω–∞—à–∏—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤:

–°–µ–≥–æ–¥–Ω—è –≤ 14:30 –≤—ã —Å–ø—Ä–∞—à–∏–≤–∞–ª–∏ –æ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞.
–í—á–µ—Ä–∞ –≤ 10:15 –º—ã –æ–±—Å—É–∂–¥–∞–ª–∏ —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞ "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∞–π—Ç–∞".
2 –¥–Ω—è –Ω–∞–∑–∞–¥ –≤—ã —Å–æ–∑–¥–∞–ª–∏ –∑–∞–¥–∞—á—É –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.

–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ 15 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞.
```

## üõ†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### Fallback —Å–∏—Å—Ç–µ–º–∞
- –ï—Å–ª–∏ –ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ ‚Üí –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è
- –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏—Å—Ç–æ—Ä–∏–∏
- –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ `chat_id` –∏ `created_at`
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –ø–æ —Ä–æ–ª—è–º
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

## üîç –û—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏
```
[INFO] [AI] History question detected: "–ø–æ–∫–∞–∂–∏ –∏—Å—Ç–æ—Ä–∏—é"
[INFO] [AI] storage = MySQL
[WARN] [AI] logMessage failed: connection error
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
```sql
-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —á–∞—Ç–∞
SELECT * FROM ai_messages WHERE chat_id = 'YOUR_CHAT_ID' ORDER BY created_at DESC;

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–æ–ª—è–º
SELECT role, COUNT(*) FROM ai_messages GROUP BY role;

-- –†–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã
SELECT COUNT(*) as total_messages, 
       MAX(created_at) as last_message 
FROM ai_messages;
```

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç

–¢–µ–ø–µ—Ä—å –≤–∞—à –±–æ—Ç:
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç** –≤–æ–ø—Ä–æ—Å—ã –æ–± –∏—Å—Ç–æ—Ä–∏–∏
- ‚úÖ **–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é** –¥–∏–∞–ª–æ–≥–æ–≤
- ‚úÖ **–ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è** –ø–æ –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ **–õ–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è** –≤ –ë–î
- ‚úÖ **–†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –±–µ–∑ –ë–î** (fallback —Ä–µ–∂–∏–º)

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –ª–µ–≥–∫–æ —É–∑–Ω–∞—Ç—å, –æ —á–µ–º –æ–Ω–∏ –≥–æ–≤–æ—Ä–∏–ª–∏ —Å –±–æ—Ç–æ–º —Ä–∞–Ω–µ–µ! üöÄ
